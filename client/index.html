<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <title>HN Mail</title>

    <style>
      html,
      body {
        height: 100%;
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        font-size: 19px;
        line-height: 1.5;
        background-color: #f6f6ef;
      }

      h1 {
        font-size: 1.4rem;
        font-weight: 600;
        margin: 0 0 1rem 0;
      }

      h2 {
        font-size: 1.2rem;
        font-weight: 600;
        margin: 0 0 1rem 0;
      }

      p {
        margin: 1.75rem 0;
      }

      main {
        margin: 4.75rem auto 0 auto;
        padding: 0 1.5rem;
        max-width: 600px;
        height: 100%;
      }

      form {
        color: #fff;
        background-color: #ff6600;
        padding: 1rem 2rem 1.5rem 2rem;
      }

      label,
      input {
        display: block;
        width: 100%;
      }

      [type='submit'] {
        margin: 0.5rem 0;
      }

      .sr-only {
        position: absolute;
        left: -10000px;
        top: auto;
        width: 1px;
        height: 1px;
        overflow: hidden;
      }

      .error {
        height: 30px;
        margin: 2rem 0;
      }

      .frequency-input {
        display: flex;
        flex-wrap: wrap;
      }

      .subscription-form {
        margin-top: 2rem;
      }

      .subscription-form__inputs {
        display: flex;
      }

      .subscription-form__email {
        margin-right: 0.5rem;
      }
    </style>
  </head>
  <body>
    <main id="main">
      <h1>HN Mail</h1>

      <p>
        Stay up to date with
        <a
          href="https://news.ycombinator.com/"
          target="_blank"
          rel="noopener noreferrer"
          >Hacker News</a
        >
        by receiving a snapshot of the top stories straight to your inbox.
      </p>

      <form id="subscription-form" class="subscription-form">
        <h2>Subscribe</h2>
        <div class="subscription-form__inputs">
          <label for="email-input" class="sr-only">Email</label>
          <input
            name="email-input"
            id="email-input"
            class="subscription-form__email"
            placeholder="your@email.com"
            type="email"
            required
          />

          <label for="frequency-input" class="sr-only">Frequency</label>
          <select name="frequency-input" id="frequency-input">
            <option value="weekly">Weekly</option>
            <option value="daily">Daily</option>
            <option value="two_daily">2 daily</option>
            <option value="three_daily">3 daily</option>
          </select>
        </div>

        <button id="subscription-submit" type="submit">Subscribe</button>
      </form>

      <p id="subscription-error"></p>
    </main>

    <script>
      ;(() => {
        document
          .getElementById('subscription-form')
          .addEventListener('submit', async e => {
            e.preventDefault()

            const emailEl = e.currentTarget.elements['email-input']
            const email = emailEl.value

            const frequencyEl = e.currentTarget.elements['frequency-input']
            const frequency = frequencyEl.value

            const submitEl = document.getElementById('subscription-submit')
            submitEl.setAttribute('disabled', true)

            try {
              const subscriptionRes = await fetch(
                'https://us-central1-hnmail.cloudfunctions.net/subscribe ',
                {
                  method: 'POST',
                  mode: 'cors',
                  body: JSON.stringify({email, frequency}),
                },
              )

              if (subscriptionRes.status !== 200)
                throw new Error('Something went wrong ðŸ¥º. Please try again.')

              const mainEl = document.getElementById('main')
              mainEl.innerText = 'ðŸŽ‰ Success!'
            } catch (error) {
              console.error(error)
              renderErrorMessage(error.message)
            } finally {
              submitEl.removeAttribute('disabled')
            }
          })

        const renderErrorMessage = message => {
          const errorContainerEl = document.getElementById('subscription-error')
          errorContainerEl.innerText = message
        }
      })()
    </script>
  </body>
</html>
